# üö¶ CURSOR RULES - ALREA SENSE

Este projeto segue as regras definidas em `rules.md`.

## üìö Documenta√ß√£o Principal

Leia SEMPRE antes de fazer mudan√ßas:
- `rules.md` - Regras de desenvolvimento e arquitetura atual
- `IMPLEMENTACAO_SISTEMA_MIDIA.md` - Guia completo do sistema de m√≠dia
- `ANALISE_COMPLETA_PROJETO_2025.md` - An√°lise arquitetural

## ‚ö†Ô∏è REGRAS CR√çTICAS

1. **N√ÉO USE CELERY** - O projeto usa RabbitMQ + aio-pika
2. **SEMPRE TESTE ANTES DE COMMIT** - Crie scripts de teste locais
3. **MULTI-TENANT FIRST** - Todo modelo precisa de `tenant_id`
4. **WEBSOCKET PARA REAL-TIME** - Use Channels, n√£o polling
5. **üîê SEGURAN√áA PRIMEIRO** - Veja se√ß√£o de seguran√ßa abaixo
6. **üì¶ VERIFICAR MIGRATIONS EXISTENTES** - Sempre checar antes de criar novas

## üì¶ REGRAS DE MIGRATIONS E DATABASE (CR√çTICO)

### ‚úÖ SEMPRE FA√áA ISSO:

1. **SEMPRE verifique migrations existentes antes de criar novas**
   ```bash
   # ‚úÖ CORRETO - Verificar primeiro
   ls backend/apps/[app]/migrations/
   # Ou
   python manage.py showmigrations [app]
   
   # Ver a √∫ltima migration
   ls backend/apps/campaigns/migrations/ | sort
   ```

2. **SEMPRE use n√∫meros sequenciais corretos**
   ```python
   # ‚úÖ CORRETO - Se √∫ltima √© 0010, criar 0011
   # ‚ùå ERRADO - Criar 0002 quando j√° existe 0010
   ```

3. **SEMPRE use `IF NOT EXISTS` em migrations SQL**
   ```python
   # ‚úÖ CORRETO
   migrations.RunSQL(
       sql="CREATE INDEX IF NOT EXISTS idx_name ON table(column);",
       reverse_sql="DROP INDEX IF EXISTS idx_name;"
   )
   ```

4. **SEMPRE teste migrations localmente primeiro**
   ```bash
   # ‚úÖ CORRETO
   python manage.py migrate [app] --plan  # Ver o que vai acontecer
   python manage.py migrate [app]         # Aplicar
   python manage.py migrate [app] zero    # Reverter se necess√°rio
   ```

### ‚ùå NUNCA FA√áA ISSO:

1. **NUNCA crie migrations sem verificar as existentes**
   ```python
   # ‚ùå ERRADO - Criar 0002 sem verificar se j√° existe 0010
   # Causa: Conflicting migrations detected
   ```

2. **NUNCA delete migrations que j√° foram aplicadas em produ√ß√£o**
   ```bash
   # ‚ùå ERRADO - Delete migration j√° aplicada
   # Causa: Inconsist√™ncia de estado do banco
   ```

3. **NUNCA fa√ßa migrations que conectam a servi√ßos externos**
   ```python
   # ‚ùå ERRADO - Conectar Redis/RabbitMQ no import
   redis_client = redis.Redis.from_url(...)  # Quebra collectstatic
   
   # ‚úÖ CORRETO - Usar lazy loading
   def get_redis_client():
       if not hasattr(settings, '_redis_client'):
           settings._redis_client = redis.Redis.from_url(...)
       return settings._redis_client
   ```

4. **NUNCA use `python manage.py migrate` no Dockerfile**
   ```dockerfile
   # ‚ùå ERRADO - Migrations no build time
   RUN python manage.py migrate
   
   # ‚úÖ CORRETO - Migrations no runtime (ap√≥s deploy)
   # Via Railway CLI ou comando manual
   ```

### üéì LI√á√ïES APRENDIDAS (Out/2025):

#### 1Ô∏è‚É£ Migrations Conflitantes
**Problema:** Criamos `0002_add_performance_indexes.py` em campaigns sem verificar.
**Resultado:** Conflito com `0010_add_performance_indexes.py` j√° existente.
**Erro:** `Conflicting migrations detected; multiple leaf nodes`
**Solu√ß√£o:** Deletar a migration duplicada, usar a existente.
**Preven√ß√£o:** SEMPRE executar `ls migrations/` antes de criar nova.

#### 2Ô∏è‚É£ Vari√°vel de Ambiente RabbitMQ Incorreta
**Problema:** `settings.py` buscava `RABBITMQ_PRIVATE_URL` mas Railway usa `RABBITMQ_URL`.
**Resultado:** Conex√£o falhava para `localhost:5672` com erro `[Errno 111] Connect call failed`.
**C√≥digo Errado:**
```python
RABBITMQ_URL = config('RABBITMQ_PRIVATE_URL', default='amqp://guest:guest@localhost:5672/')
```
**Solu√ß√£o:** Usar nome correto da vari√°vel + log seguro mascarando credenciais.
**Preven√ß√£o:** 
- Verificar nomes exatos das vari√°veis no Railway/ambiente
- NUNCA usar credenciais hardcoded como fallback
- Sempre mascarar credenciais em logs

#### 3Ô∏è‚É£ Credenciais Hardcoded em Fallbacks
**Problema:** `rabbitmq_consumer.py` tinha credenciais do Railway hardcoded como fallback.
**Resultado:** Vazamento de credenciais no c√≥digo fonte.
**C√≥digo Errado:**
```python
rabbitmq_url = getattr(settings, 'RABBITMQ_URL', 
    'amqp://user:pass@rabbitmq.railway.internal:5672')
```
**Solu√ß√£o:** Sempre usar `settings.RABBITMQ_URL` direto, sem fallback inseguro.
**Preven√ß√£o:** 
- NUNCA colocar credenciais reais em defaults/fallbacks
- Se ambiente n√£o tiver vari√°vel, melhor falhar do que usar credencial insegura
- Usar pre-commit hooks para detectar padr√µes de credenciais

---

## ‚ö° REGRAS DE PERFORMANCE E CODE QUALITY (CR√çTICO)

### ‚ùå NUNCA FA√áA ISSO:

1. **NUNCA use print() em c√≥digo de produ√ß√£o**
   ```python
   # ‚ùå ERRADO
   print(f"Debug info: {data}")
   
   # ‚úÖ CORRETO
   import logging
   logger = logging.getLogger(__name__)
   logger.debug("Debug info", extra={'data': data})
   ```

2. **NUNCA ignore N+1 queries**
   ```python
   # ‚ùå ERRADO - N+1 query problem
   campaigns = Campaign.objects.filter(tenant=tenant)
   for campaign in campaigns:
       print(campaign.instances.count())  # Query por campanha!
   
   # ‚úÖ CORRETO
   campaigns = Campaign.objects.filter(tenant=tenant).prefetch_related('instances')
   ```

3. **NUNCA use bare `except Exception`**
   ```python
   # ‚ùå ERRADO - esconde erros espec√≠ficos
   try:
       send_message()
   except Exception as e:
       logger.error(f"Error: {e}")
   
   # ‚úÖ CORRETO - exce√ß√µes espec√≠ficas
   from requests.exceptions import Timeout, ConnectionError
   try:
       send_message()
   except Timeout as e:
       logger.warning("Timeout, will retry", exc_info=True)
       return retry_later()
   except ConnectionError as e:
       logger.error("Connection failed", exc_info=True)
       raise
   ```

4. **NUNCA deixe endpoints p√∫blicos sem rate limiting**
   ```python
   # ‚ùå ERRADO
   @api_view(['POST'])
   @permission_classes([AllowAny])
   def webhook(request):
       pass
   
   # ‚úÖ CORRETO
   from apps.common.rate_limiting import rate_limit_by_ip
   
   @api_view(['POST'])
   @permission_classes([AllowAny])
   @rate_limit_by_ip(rate='100/m')
   def webhook(request):
       pass
   ```

5. **NUNCA crie arquivos *debug*.py em produ√ß√£o**
   ```python
   # ‚ùå ERRADO - arquivos tempor√°rios de debug
   backend/debug_something.py
   backend/apps/campaigns/views_debug.py  # Se existir, DEVE ter @IsAdminUser
   
   # ‚úÖ CORRETO - scripts de debug em pasta separada
   scripts/debug/test_something.py
   ```

### ‚úÖ SEMPRE FA√áA ISSO:

1. **SEMPRE use select_related/prefetch_related**
   ```python
   # ‚úÖ CORRETO - otimizar queries
   conversations = Conversation.objects.select_related(
       'tenant', 'department', 'assigned_to'
   ).prefetch_related('participants')
   
   campaigns = Campaign.objects.filter(tenant=tenant).prefetch_related(
       'instances',
       'messages',
       Prefetch('contacts', queryset=CampaignContact.objects.select_related('contact'))
   )
   ```

2. **SEMPRE use √≠ndices compostos para queries frequentes**
   ```python
   # ‚úÖ CORRETO - criar migration com √≠ndices compostos
   migrations.RunSQL(
       sql="""
           CREATE INDEX IF NOT EXISTS idx_conv_tenant_dept_status 
           ON chat_conversation(tenant_id, department_id, status);
       """,
       reverse_sql="DROP INDEX IF EXISTS idx_conv_tenant_dept_status;"
   )
   ```

3. **SEMPRE use atomic transactions em opera√ß√µes cr√≠ticas**
   ```python
   # ‚úÖ CORRETO
   from django.db import transaction
   
   @transaction.atomic
   def create_campaign_with_contacts(campaign_data, contacts):
       campaign = Campaign.objects.create(**campaign_data)
       CampaignContact.objects.bulk_create([
           CampaignContact(campaign=campaign, contact=c)
           for c in contacts
       ], batch_size=1000)
       return campaign
   ```

4. **SEMPRE use bulk_create para inser√ß√µes em massa**
   ```python
   # ‚ùå ERRADO - 1000 queries
   for contact in contacts:
       CampaignContact.objects.create(campaign=campaign, contact=contact)
   
   # ‚úÖ CORRETO - 1 query
   CampaignContact.objects.bulk_create([
       CampaignContact(campaign=campaign, contact=c)
       for c in contacts
   ], batch_size=1000, ignore_conflicts=True)
   ```

5. **SEMPRE proteja endpoints de debug**
   ```python
   # ‚úÖ CORRETO
   from rest_framework.permissions import IsAuthenticated, IsAdminUser
   
   @api_view(['GET'])
   @permission_classes([IsAuthenticated, IsAdminUser])
   def debug_view(request):
       # Apenas admins podem acessar
       pass
   ```

### üöÄ FERRAMENTAS DISPON√çVEIS:

1. **Performance Middleware** (`apps.common.performance_middleware`)
   - Adiciona header `X-Response-Time` em todas as respostas
   - Loga requests lentos (> 1 segundo)
   - Em DEBUG: adiciona `X-DB-Query-Count` header

2. **Rate Limiting** (`apps.common.rate_limiting`)
   ```python
   from apps.common.rate_limiting import rate_limit_by_user, rate_limit_by_ip
   
   @rate_limit_by_user(rate='10/h', method='POST')  # 10 por hora por usu√°rio
   @rate_limit_by_ip(rate='100/m')  # 100 por minuto por IP
   ```

3. **Logging Estruturado**
   ```python
   logger.info("Message sent", extra={
       'campaign_id': str(campaign.id),
       'contact_id': str(contact.id),
       'instance_id': str(instance.id),
   })
   ```

### üìä CHECKLIST DE PERFORMANCE:

Antes de commitar c√≥digo novo, verifique:

- [ ] Nenhum print() no c√≥digo?
- [ ] Queries otimizadas com select_related/prefetch_related?
- [ ] Bulk operations ao inv√©s de loops?
- [ ] Transactions em opera√ß√µes cr√≠ticas?
- [ ] Exception handling espec√≠fico?
- [ ] Rate limiting em endpoints p√∫blicos?
- [ ] Logging estruturado ao inv√©s de print()?
- [ ] √çndices para queries frequentes?

### üéì LI√á√ÉO APRENDIDA (Out/2025):

**Problema:** 187 print() statements em produ√ß√£o, logs n√£o estruturados.
**Resultado:** Dif√≠cil debugging, logs n√£o aparecem em sistemas centralizados.
**Solu√ß√£o:** Substituir TODOS os print() por logging.{level}() com contexto.
**Preven√ß√£o:** Pre-commit hook bloqueando novos print().

**Problema:** Queries N+1 em listagem de campanhas (301 queries!).
**Resultado:** Tempo de resposta > 800ms.
**Solu√ß√£o:** prefetch_related('instances', 'messages') ‚Üí 1 query, <100ms.
**Preven√ß√£o:** Sempre usar DatabaseQueryCountMiddleware em DEBUG.

**Problema:** Endpoints de debug p√∫blicos expondo dados de todos os tenants.
**Resultado:** Vazamento potencial de informa√ß√µes.
**Solu√ß√£o:** @permission_classes([IsAuthenticated, IsAdminUser]) obrigat√≥rio.
**Preven√ß√£o:** NUNCA usar @permission_classes([AllowAny]) em views de debug.

---

## üîê REGRAS DE SEGURAN√áA (CR√çTICO)

### ‚ùå NUNCA FA√áA ISSO:

1. **NUNCA hardcode credenciais no c√≥digo**
   ```python
   # ‚ùå ERRADO
   API_KEY = '584B4A4A-0815-AC86-DC39-C38FC27E8E17'
   SECRET_KEY = config('SECRET_KEY', default='chave-hardcoded')
   ```

2. **NUNCA exponha API keys em plaintext**
   ```python
   # ‚ùå ERRADO
   return Response({'api_key': connection.api_key})
   ```

3. **NUNCA use CORS_ALLOW_ALL_ORIGINS = True**
   ```python
   # ‚ùå ERRADO
   CORS_ALLOW_ALL_ORIGINS = True
   ```

4. **NUNCA commite secrets no Git**
   - Sempre use vari√°veis de ambiente
   - Use pre-commit hooks para detectar

5. **NUNCA use defaults com valores reais**
   ```python
   # ‚ùå ERRADO
   S3_KEY = getattr(settings, 'S3_KEY', 'valor-real-aqui')
   ```

### ‚úÖ SEMPRE FA√áA ISSO:

1. **SEMPRE use vari√°veis de ambiente**
   ```python
   # ‚úÖ CORRETO
   EVOLUTION_API_KEY = config('EVOLUTION_API_KEY')  # Sem default
   SECRET_KEY = config('SECRET_KEY')  # Sem default
   ```

2. **SEMPRE mascare secrets em respostas de API**
   ```python
   # ‚úÖ CORRETO
   api_key_masked = '****' + api_key[-4:] if len(api_key) > 4 else ''
   return Response({
       'api_key': api_key_masked,
       'api_key_set': bool(connection.api_key)
   })
   ```

3. **SEMPRE restrinja CORS**
   ```python
   # ‚úÖ CORRETO
   CORS_ALLOW_ALL_ORIGINS = False
   CORS_ALLOWED_ORIGINS = [
       'https://alreasense-production.up.railway.app',
       'http://localhost:5173',  # Apenas em dev
   ]
   ```

4. **SEMPRE use pre-commit hooks**
   ```bash
   # Instalar e configurar
   pip install pre-commit
   pre-commit install
   ```

5. **SEMPRE logue acessos sens√≠veis**
   ```python
   # ‚úÖ CORRETO
   logger.warning(f"üîê SENSITIVE ACCESS: {user} acessou {path}")
   ```

6. **SEMPRE implemente rate limiting**
   ```python
   # Para endpoints cr√≠ticos de autentica√ß√£o e configura√ß√£o
   @ratelimit(key='ip', rate='10/h', method='POST')
   ```

### üõ°Ô∏è PROTE√á√ïES IMPLEMENTADAS:

1. **Security Middleware** (`apps.common.security_middleware`)
   - Auditoria autom√°tica de acessos sens√≠veis
   - Security headers autom√°ticos
   - Rate limiting b√°sico

2. **Pre-commit Hooks** (`.pre-commit-config.yaml`)
   - Detecta credenciais antes do commit
   - Bloqueia secrets automaticamente
   - Verifica debug prints

3. **API Key Masking** (todas as views de configura√ß√£o)
   - Keys sempre mascaradas em GET
   - Flag `api_key_set` indica se configurada
   - Aceita update mas nunca retorna completa

4. **Fail Securely**
   - Se credencial n√£o existe ‚Üí sistema falha (comportamento desejado)
   - Melhor quebrar do que usar defaults inseguros

### üìã CHECKLIST DE SEGURAN√áA:

Antes de commitar c√≥digo novo, verifique:

- [ ] Nenhuma credencial hardcoded?
- [ ] Secrets mascarados em APIs?
- [ ] Vari√°veis de ambiente usadas?
- [ ] CORS restrito?
- [ ] Endpoints sens√≠veis com autentica√ß√£o?
- [ ] Rate limiting implementado?
- [ ] Logs de auditoria adicionados?
- [ ] Pre-commit hooks passaram?

### üìö DOCUMENTA√á√ÉO DE SEGURAN√áA:

- `ANALISE_SEGURANCA_COMPLETA.md` - An√°lise detalhada
- `README_SEGURANCA_URGENTE.md` - Guia r√°pido
- `REFATORACAO_COMPLETA.md` - Mudan√ßas aplicadas
- `ROTACAO_CREDENCIAIS_URGENTE.md` - Como rotacionar

## üéØ STACK ATUAL

- Backend: Django 5 + DRF + Channels + RabbitMQ
- Frontend: React 18 + TypeScript + Vite + Zustand
- Database: PostgreSQL 15 + pgvector
- Cache: Redis 7
- Storage: MinIO/S3 (Railway)
- Queue: RabbitMQ (N√ÉO Celery!)

## üì¶ PRODUTOS ATIVOS

- Flow (Campanhas + Chat + Contatos)
- Sense (IA - legado)
- Notifications
- API P√∫blica

Para detalhes completos, consulte `rules.md`.

