{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% csrf_token %}

{% block title %}Monitoramento do RabbitMQ | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:campaigns_campaign_changelist' %}">{% trans 'Campaigns' %}</a>
&rsaquo; <a href="{% url 'admin:campaigns_campaign_changelist' %}">{% trans 'Campaigns' %}</a>
&rsaquo; {% trans 'RabbitMQ Monitoring' %}
</div>
{% endblock %}

{% block content %}
<div class="module aligned">
    <h1>🐰 Monitoramento do RabbitMQ</h1>
    
    <!-- Status Geral -->
    <div class="form-row">
        <div class="field-box">
            <h3>📊 Status Geral</h3>
            <div class="status-grid">
                <div class="status-item">
                    <strong>RabbitMQ:</strong>
                    <span class="status-{{ rabbitmq_status.status|default:'unknown' }}">
                        {% if rabbitmq_status.status == 'healthy' %}
                            ✅ Conectado
                        {% elif rabbitmq_status.status == 'not_configured' %}
                            ⚠️ Não Configurado
                        {% elif rabbitmq_status.status == 'unhealthy' %}
                            ❌ Erro
                        {% else %}
                            ❓ Desconhecido
                        {% endif %}
                    </span>
                </div>
                <div class="status-item">
                    <strong>Consumer:</strong>
                    <span class="status-{{ consumer_status }}">
                        {% if consumer_status == 'running' %}
                            ✅ Rodando
                        {% elif consumer_status == 'not_configured' %}
                            ⚠️ Não Configurado
                        {% elif consumer_status == 'error' %}
                            ❌ Erro
                        {% else %}
                            ❓ Desconhecido
                        {% endif %}
                    </span>
                </div>
                <div class="status-item">
                    <strong>Campanhas Ativas:</strong>
                    <span class="status-active">{{ active_campaigns_count }}</span>
                </div>
                <div class="status-item">
                    <strong>Última Atualização:</strong>
                    <span class="status-time">{{ current_time|date:"d/m/Y H:i:s" }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas das Campanhas -->
    <div class="form-row">
        <div class="field-box">
            <h3>📈 Estatísticas das Campanhas</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">{{ total_campaigns }}</div>
                    <div class="stat-label">Total de Campanhas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ running_campaigns }}</div>
                    <div class="stat-label">Campanhas Rodando</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ paused_campaigns }}</div>
                    <div class="stat-label">Campanhas Pausadas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ pending_contacts }}</div>
                    <div class="stat-label">Contatos Pendentes</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas de Mensagens -->
    <div class="form-row">
        <div class="field-box">
            <h3>📨 Estatísticas de Mensagens</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">{{ message_stats.total_sent|default:0 }}</div>
                    <div class="stat-label">Total Enviadas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ message_stats.total_delivered|default:0 }}</div>
                    <div class="stat-label">Total Entregues</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ message_stats.total_failed|default:0 }}</div>
                    <div class="stat-label">Total Falharam</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">
                        {% if message_stats.total_sent > 0 %}
                            {{ message_stats.total_delivered|default:0|floatformat:1 }}%
                        {% else %}
                            0%
                        {% endif %}
                    </div>
                    <div class="stat-label">Taxa de Entrega</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Campanhas Ativas -->
    {% if active_campaigns %}
    <div class="form-row">
        <div class="field-box">
            <h3>🚀 Campanhas Ativas no RabbitMQ</h3>
            <div class="active-campaigns">
                {% for campaign_id in active_campaigns %}
                <div class="campaign-item">
                    <strong>{{ campaign_id }}</strong>
                    <span class="status-running">✅ Ativa</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Controles do RabbitMQ Consumer -->
    <div class="form-row">
        <div class="field-box">
            <h3>🎛️ Controles do RabbitMQ Consumer</h3>
            <div class="consumer-controls">
                <button onclick="controlConsumer('start')" class="btn btn-success" id="startBtn">
                    ▶️ Iniciar Consumer
                </button>
                <button onclick="controlConsumer('stop')" class="btn btn-danger" id="stopBtn">
                    ⏹️ Parar Consumer
                </button>
                <button onclick="controlConsumer('restart')" class="btn btn-warning" id="restartBtn">
                    🔄 Reiniciar Consumer
                </button>
                <button onclick="getConsumerStatus()" class="btn btn-info" id="statusBtn">
                    📊 Status Detalhado
                </button>
            </div>
            <div id="consumerStatus" class="consumer-status">
                <div class="status-item">
                    <strong>Consumer:</strong>
                    <span id="consumerStatusText">Verificando...</span>
                </div>
                <div class="status-item">
                    <strong>Conexão:</strong>
                    <span id="connectionStatusText">Verificando...</span>
                </div>
                <div class="status-item">
                    <strong>Monitor:</strong>
                    <span id="monitorStatusText">Verificando...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles Gerais -->
    <div class="form-row">
        <div class="field-box">
            <h3>🔧 Controles Gerais</h3>
            <div class="controls">
                <button onclick="refreshData()" class="btn btn-primary">🔄 Atualizar Dados</button>
                <button onclick="toggleAutoRefresh()" class="btn btn-secondary" id="autoRefreshBtn">
                    ⏱️ Auto-refresh (30s)
                </button>
                <a href="{% url 'admin:campaigns_campaign_changelist' %}" class="btn btn-link">
                    📋 Ver Todas as Campanhas
                </a>
            </div>
        </div>
    </div>

    <!-- Log de Atividades -->
    <div class="form-row">
        <div class="field-box">
            <h3>📝 Log de Atividades</h3>
            <div id="activityLog" class="activity-log">
                <div class="log-entry">Sistema inicializado - {{ current_time|date:"d/m/Y H:i:s" }}</div>
            </div>
        </div>
    </div>
</div>

<style>
.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 15px 0;
}

.status-item {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    border-left: 4px solid #007cba;
}

.status-healthy, .status-running, .status-active {
    color: #28a745;
    font-weight: bold;
}

.status-not_configured, .status-paused {
    color: #ffc107;
    font-weight: bold;
}

.status-unhealthy, .status-error {
    color: #dc3545;
    font-weight: bold;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin: 15px 0;
}

.stat-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px solid #e9ecef;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #007cba;
    margin-bottom: 5px;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9em;
}

.active-campaigns {
    margin: 15px 0;
}

.campaign-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin: 5px 0;
    background: #e8f5e8;
    border-radius: 5px;
    border-left: 4px solid #28a745;
}

.controls {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    flex-wrap: wrap;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
}

.btn-primary {
    background: #007cba;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-link {
    background: none;
    color: #007cba;
    text-decoration: underline;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.consumer-controls {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    flex-wrap: wrap;
}

.consumer-status {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
    border: 1px solid #dee2e6;
}

.activity-log {
    max-height: 200px;
    overflow-y: auto;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
    font-family: monospace;
    font-size: 12px;
}

.log-entry {
    padding: 2px 0;
    border-bottom: 1px solid #e9ecef;
}

.log-entry:last-child {
    border-bottom: none;
}

.field-box {
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.field-box h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #333;
    border-bottom: 2px solid #007cba;
    padding-bottom: 5px;
}
</style>

<script>
let autoRefreshInterval = null;
let autoRefreshEnabled = false;

function refreshData() {
    fetch('{% url "admin:campaigns_campaign_rabbitmq_monitoring_api" %}')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateDisplay(data.data);
                addLogEntry('Dados atualizados com sucesso');
            } else {
                addLogEntry('Erro ao atualizar dados: ' + data.message);
            }
        })
        .catch(error => {
            addLogEntry('Erro de conexão: ' + error.message);
        });
}

function updateDisplay(data) {
    // Atualizar status do RabbitMQ
    const rabbitmqStatus = document.querySelector('.status-healthy, .status-not_configured, .status-unhealthy');
    if (rabbitmqStatus) {
        rabbitmqStatus.textContent = data.rabbitmq_status.status === 'healthy' ? '✅ Conectado' : 
                                   data.rabbitmq_status.status === 'not_configured' ? '⚠️ Não Configurado' : '❌ Erro';
    }

    // Atualizar campanhas ativas
    const activeCampaigns = document.querySelector('.status-active');
    if (activeCampaigns) {
        activeCampaigns.textContent = data.active_campaigns_count;
    }

    // Atualizar estatísticas
    const stats = data.db_stats;
    document.querySelectorAll('.stat-number').forEach((element, index) => {
        const values = [stats.total_campaigns, stats.running_campaigns, stats.paused_campaigns, stats.pending_contacts];
        if (values[index] !== undefined) {
            element.textContent = values[index];
        }
    });
}

function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    
    if (autoRefreshEnabled) {
        clearInterval(autoRefreshInterval);
        autoRefreshEnabled = false;
        btn.textContent = '⏱️ Auto-refresh (30s)';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-secondary');
        addLogEntry('Auto-refresh desabilitado');
    } else {
        autoRefreshInterval = setInterval(refreshData, 30000);
        autoRefreshEnabled = true;
        btn.textContent = '⏹️ Parar Auto-refresh';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-success');
        addLogEntry('Auto-refresh habilitado (30s)');
    }
}

function addLogEntry(message) {
    const log = document.getElementById('activityLog');
    const timestamp = new Date().toLocaleString('pt-BR');
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.textContent = `[${timestamp}] ${message}`;
    log.insertBefore(entry, log.firstChild);
    
    // Manter apenas os últimos 50 logs
    while (log.children.length > 50) {
        log.removeChild(log.lastChild);
    }
}

function controlConsumer(action) {
    const formData = new FormData();
    formData.append('action', action);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Desabilitar botões durante a ação
    const buttons = document.querySelectorAll('.consumer-controls button');
    buttons.forEach(btn => btn.disabled = true);
    
    fetch('{% url "admin:campaigns_campaign_rabbitmq_control_api" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            addLogEntry(`✅ ${action.toUpperCase()}: ${data.message}`);
            updateConsumerStatus(data.data);
        } else {
            addLogEntry(`❌ ${action.toUpperCase()}: ${data.message}`);
        }
    })
    .catch(error => {
        addLogEntry(`❌ Erro ao ${action}: ${error.message}`);
    })
    .finally(() => {
        // Reabilitar botões
        buttons.forEach(btn => btn.disabled = false);
    });
}

function getConsumerStatus() {
    controlConsumer('status');
}

function updateConsumerStatus(statusData) {
    if (!statusData) return;
    
    // Atualizar status do consumer
    const consumerStatusText = document.getElementById('consumerStatusText');
    const connectionStatusText = document.getElementById('connectionStatusText');
    const monitorStatusText = document.getElementById('monitorStatusText');
    
    if (consumerStatusText) {
        consumerStatusText.textContent = statusData.is_running ? '✅ Rodando' : '❌ Parado';
        consumerStatusText.className = statusData.is_running ? 'status-healthy' : 'status-unhealthy';
    }
    
    if (connectionStatusText) {
        const connectionStatus = statusData.connection_status || 'unknown';
        connectionStatusText.textContent = connectionStatus === 'connected' ? '✅ Conectado' : 
                                          connectionStatus === 'disconnected' ? '❌ Desconectado' : '❓ Desconhecido';
        connectionStatusText.className = connectionStatus === 'connected' ? 'status-healthy' : 'status-unhealthy';
    }
    
    if (monitorStatusText) {
        monitorStatusText.textContent = statusData.monitor_running ? '✅ Ativo' : '❌ Inativo';
        monitorStatusText.className = statusData.monitor_running ? 'status-healthy' : 'status-unhealthy';
    }
    
    // Atualizar contadores
    const activeCampaigns = document.querySelector('.status-active');
    if (activeCampaigns) {
        activeCampaigns.textContent = statusData.active_campaigns_count || 0;
    }
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    addLogEntry('Página de monitoramento carregada');
    refreshData();
    getConsumerStatus(); // Verificar status do consumer ao carregar
});
</script>
{% endblock %}
